<!DOCTYPE html>
<html>
    <head>
        <title>LibAnswers - Get Topics</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    </head>
    <body>
        <div>
            <script>
                $(document).ready(function () {
                    // initial page setup
                    $('#topics').hide();
                    $('#resultsPanel').hide();
                    // clear previous values if any exist
                    $('#topics_select').empty();
                    var libID, myURL;
                    // Get and display a list of topics from the LibAnswers system
                    $('#btnLibraryID').click(function () {
                        console.log("button clicked");
                        // clear previous values if any exist
                        //$('#topics_select').empty();

                        libID = $('#libraryID').val();
                        myURL = "https://ccac.libanswers.com/1.0/topics?iid=" + libID + "&sort=count&sort_dir=desc&callback=?";
                        $.getJSON(myURL, function (items) {
                            var name = items.data.topics;
                            //array of items
                            console.log(name);
                            //TODO make the this.topic_id numbers hyperlinked to display the faq items for the topic_id number.
                            $.each(name, function () {
                                output = "<option value='" + this.topic_id + "'>" + this.name + "</option>";
                                $('#topicSelect').append("<option value='" + this.topic_id + "'>" + this.name + " (" + this.count + ")" + "</option>");
                                console.log(this.name);
                            });
                        });
                        $('#topics').show();
                    });
                    // iid = the library id number - this is unique to each library
                    // https://ccac.libanswers.com/1.0/topics?iid=2042&sort=count&sort_dir=desc

                    $('#topicSelect').change(function () {
                        op = $(this).children('option:selected').val();
                        console.log(op);
                        // clear the faqResults preview
                        $("#faqResults").empty();
                        createFAQ(op);
                    });

                    $('#sortSelect').change(function(){
                    // TODO Update feed when the sort type is selected
                    op = $(this).children('option:selected').val();
                    // TODO set global var for sort type and then call createFAQ();
                    // update createFAQ to pull in the global vars.

                    createFAQ();
                    console.log("Sort type: " + op);
                    });

                    $('#sortDirectionSelect').change(function(){
                    // TODO Update the feed when the sort direction is selected
                    op = $(this).children('option:selected').val();
                    console.log("Sort Dir: " + op);
                    });



                    function createFAQ(id) {
                        var url = "https://ccac.libanswers.com/1.0/faqs?iid=2042&topic_id=" + id + "&sort=totalhits&sort_dir=desc&callback=?";
                        console.log(url);
                        var output = "";
                        $.getJSON(url, function (data) {
                            $.each(data.data.faqs, function () {
                                var faqid = this.faqid;
                                // Build the accordion for each FAQ entry
                                output += '<div id="faqItems" class="panel panel-default">';
                                output += "<div class='panel-heading' role='tab' id=\"heading_" + this.faqid + '">';
                                output += '<h4 class="panel-title"><span class="fa fa-question-circle fa-lg" aria-hidden="true" style="color:#800000;"></span>&nbsp;&nbsp;';
                                output += '<a role="button" data-toggle="collapse" data-parent="#accordion" href="#' + faqid + '" aria-expanded="false" aria-controls="' + faqid + '">';
                                output += this.question + " (" + this.totalhits + ')</a></h4></div>';
                                output += '<div id=\"' + faqid + '" class="panel-collapse collapse" role="tabpanel" aria-labelledby="' + faqid + '"><div class="panel-body">';
                                output += this.answer;

                                // If FAQ entry has links, display them below the body.
                                if (this.links.length > 0) {
                                    output += '<h4>Links</h4><div class="well"><ul>';
                                    for (i = 0; i < this.links.length; i++) {
                                        output += '<li><a href="' + this.links[i].url + '">' + this.links[i].title + "</a></li>";
                                    }
                                    output += '</ul></div>';
                                }

                                // If FAQ entry has files, display links to them below the body.
                                if (this.files.length > 0) {
                                    output += '<h4>Files</h4><div class="well"><ul>';
                                    for (i = 0; i < this.files.length; i++) {
                                        output += '<li><a href="' + this.files[i].url + '">' + this.files[i].title + "</a></li>";
                                    }
                                    output += '</ul></div>';
                                }

                                // If FAQ entry has media items, display links to them below the body.
                                if (this.media.length > 0) {
                                    output += '<h4>Media</h4><div class="well"><ul>';
                                    for (i = 0; i < this.media.length; i++) {
                                        output += '<li><a href="' + this.media[i].content.url + '">' + this.media[i].title + "</a></li>";
                                    }
                                    output += '</ul></div>';
                                }

                                output += '</div></div></div>';
                            });
                            $("#faqResults").append(output);
                            $('#resultsPanel').show();

                        });

                    }
                });

            </script>
            <div class="container">
                <div class="row">
                    <div class="col-md-5">

                        <div class="form-group">
                            <label>Enter your LibAnswers site #: </label>
                            <input id="libraryID" type="text" class="form-control">
                            <button id="btnLibraryID" class="btn btn-default" type="submit">Submit</button>
                        </div>

                        <br>
                        <div id="topics" class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title">List of available topics</h3>
                            </div>
                            <div class="panel-body">
                                <div><select id="topicSelect" size="10"></select></div>


                                <h4>Sort by:</h4>
                                <select id="sortSelect">
                                    <option value="totalhits">Total Hits</option>
                                    <option value="question">Alphabetical</option>
                                    <option value="updated">Last updated</option>
                                    <option value="created">Date created</option>
                                </select>

                                <h4>Sort direction:</h4>
                                <select id="sortDirectionSelect">
                                    <option value="asc">Ascending</option>
                                    <option value="desc">Descending</option>
                                </select>

                            </div>

                        </div>
                    </div>

                    <div class="col-md-6">
                        <div id ="resultsPanel" class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title">FAQ items</h3>
                            </div>
                            <div class="panel-body">
                                <div class="panel-group" id="faqResults" role="tablist" aria-multiselectable="true">

                                </div>
                            </div>
                        </div>
                    </div>

                </div>


            </div>
    </body>
</html>
